<!DOCTYPE html>
<html>
	<head>
		<title>NaclNES</title>
		<script src="jquery-1.4.4.min.js" type="text/javascript"></script>
		<script src="game_database.json" type="text/javascript"></script>
	</head>
	<body id="bodyId" onunload="pageDidUnload()">
		<script type="text/javascript">
			var nacl_nes = null;
			var is_running = false;
			var paintInterval = null;
			var debugInterval = null;
			var gamepadInterval = null;
			var vfps = 0;
			var zoom = 1;
			var max_zoom = 4;

			function stringToBytes(str) {
				var retval = new Array();
				for(var j=0; j < str.length; j++) {
					var result = 0;
					for(var i=j + 1; i>j; i--) {
						result = result * 256 + (str.charCodeAt(i-1) & 0xff);
					}

					retval.push(result);
				}
				return retval;
			}

			function handleMessage(message_event) {
				if(message_event.data.split(':')[0] == 'get_fps') {
					var debug = $('#debug')[0];
					debug.innerHTML = 'FPS: ' + vfps + ', VFPS: ' + message_event.data.split(':')[1];
					vfps = 0;
				} else if(message_event.data.split(':')[0] == 'get_sha256') {
					// Fill in the info for this game
					var sha256 = message_event.data.split(':')[1];
					var has_fields = game_database[sha256] != undefined;
					var fields = ["name", "developer", "publisher", "region", "release_date", 
									"number_of_players", "can_save", "mapper"];
					for(i=0; i<fields.length; i++) {
						var field = fields[i];
						var value = '?';
						if(has_fields)
							value = game_database[sha256][field];
						$('#game_' + field)[0].innerHTML = value;
					}

					// Fill in the image and link to wikipedia
					if(has_fields) {
						$('#game_link')[0].innerHTML = "<a href=\"" + game_database[sha256]['link'] + "\">Wikipedia</a>";
						$('#game_img')[0].innerHTML = "<img src=\"" + game_database[sha256]['img'] + "\" width=\"200\"/>";
					}
				} else if(message_event.data.split(':')[0] == 'get_gamepad_status') {
					var status = message_event.data.split(':')[1];
					if(status == "yes") {
						$('#gamepad_indicator')[0].style.display = 'inline';
					} else {
						$('#gamepad_indicator')[0].style.display = 'none';
					}
				} else if(message_event.data == 'running') {
					is_running = true;
					// Repaint the screen
					// FIXME: Paint calls should happen automatically inside the nexe.
					var fps = 60.0;
					paintInterval = setInterval(function() {
						nacl_nes.postMessage('paint');
						vfps += 1;
					}, 1000.0 / fps);

					// Have the FPS sent to us every second
					// FIXME: This should just be sent from the nexe directly
					debugInterval = setInterval(function() {
						nacl_nes.postMessage('get_fps');
					}, 1000);
			
					// Make the pause button clickable
					$('#pause').attr('disabled', false);
					
					// Get the rom sha256
					nacl_nes.postMessage('get_sha256');
			
					var debug = $('#debug')[0];
					debug.innerHTML = message_event.data;
				} else {
					var debug = $('#debug')[0];
					debug.innerHTML = message_event.data;
				}
			}

			function handleProgress(event) {
				var debug = $('#debug')[0];
				// Print unknown progress if unknown
				if(!event.lengthComputable || event.total == 0) {
					debug.innerHTML = 'Loading ' + event.loaded + ' Bytes of unknown total size';
					return;
				}

				// Or print progress
				var progress = event.loaded / event.total * 100.0;
				debug.innerHTML = 'Loading ' + progress.toFixed(2) + '% ...';
			}

			function handleLoadEnd() {
				nacl_nes = $('#NaclNesApp')[0];
			
				$('#game_selector').attr('disabled', false);
				var debug = $('#debug')[0];
				debug.innerHTML = 'Loaded';
			
				gamepadInterval = setInterval(function() {
					nacl_nes.postMessage('get_gamepad_status');
				}, 2000);
			}

			function pageDidUnload() {
				clearInterval(paintInterval);
			}

			function load_rom(rom_url) {
				$.ajax({
					url: rom_url,
					xhr: function() {
						var xhr = $.ajaxSettings.xhr();
						if(typeof xhr.overrideMimeType !== 'undefined') {
							// Download as binary
							xhr.overrideMimeType('text/plain; charset=x-user-defined');
						}
						return xhr;
					},
					complete: function(xhr, status) {
						// Make sure the rom file exists
						if(status != 'success') {
							var debug = $('#debug')[0];
							debug.innerHTML = 'Failed to download ROM file!';
							return;
						}

						// Convert the rom to a string of bytes
						// like: [255, 12] == "FF0C"
						var response = stringToBytes(xhr.responseText);
						var rom_data = "";
						for(var i=0; i<response.length; i++) {
							var byte = response[i].toString(16).toUpperCase();
							if(byte.length == 1)
								byte = "0" + byte;
							rom_data += byte;
						}

						// Send the rom to the nexe
						nacl_nes.postMessage('load_rom:' + rom_data);
						nacl_nes.postMessage('zoom:' + zoom);
					}
				});
			}

		</script>
		<div style="float: left;">
			<p>
				<b>Status:</b><br />
				<span id="debug">Debug messages will be printed here</span>
			</p>

			<p>
				<b>Controls:</b><br />
				Enter = Start<br />
				Ctrl = Select<br />
				Z = B<br />
				X = A<br />
				Arrow keys for the D-Pad
			</p>

			<p id="gamepad_indicator" style="display: none;">
				<b>Gamepad is connected</b>
			</p>

			<p>
				<b>Game:</b><br />
				Name: <span  id="game_name">...</span><br />
				Developer: <span  id="game_developer">...</span><br />
				Publisher: <span  id="game_publisher">...</span><br />
				Region: <span  id="game_region">...</span><br />
				Release date: <span  id="game_release_date">...</span><br />
				Number of players: <span  id="game_number_of_players">...</span><br />
				Can save: <span  id="game_can_save">...</span><br />
				Mapper: <span  id="game_mapper">...</span><br />
				Link: <span  id="game_link">...</span><br />
				Image: <br /><span  id="game_img">...</span>
			</p>
		</div>

		<div id="listener" style="text-align: center;">
			<div>
				<select id="game_selector" disabled="disabled">
					<option id="none">Select a game to play ...</option>
					<option id="castlevania_1.nes">Castlevania</option>
					<option id="contra.nes">Contra</option>
					<option id="dd.nes">Double Dragon</option>
					<option id="KidIcaru.nes">Kid Icarus</option>
					<option id="Kirby's Adventure.nes">Kirby's Adventure</option>
					<option id="zelda.nes">Legend of Zelda, The</option>
					<option id="Little Nemo - The Dream Master.nes">Little Nemo - The Dream Master</option>
					<option id="MEGAMAN2.NES">Mega Man 2</option>
					<option id="metalgear.nes">Meta Gear</option>
					<option id="METROID.NES">Metroid</option>
					<option id="NinjaGa.nes">Ninja Gaiden</option>
					<option id="PunchOut.nes">Punch Out</option>
					<option id="Shatterhand.nes">Shatter Hand</option>
					<option id="Strider.nes">Strider</option>
					<option id="mario.nes">Super Mario Brothers</option>
					<option id="smb3.nes">Super Mario Brothers 3</option>
					<option id="TETRIS.NES">Tetris</option>
				</select>
				<button id="pause" disabled="disabled">Pause</button>
				zoom: 
				<button id="zoom_out" disabled="disabled">-</button>
				<button id="zoom_in" disabled="disabled">+</button>
			</div>
			<embed name="nacl_module"
				id="NaclNesApp"
				width=256 height=240
				style="background-color: #000000;"
				src="newlib/nacl_nes.nmf"
				type="application/x-nacl" />
		</div>

		<script type="text/javascript">
			// Send all key down events to the nacl app
			$('#bodyId').keydown(function(event) {
				// Let the browser handle F11 for full screen
				if(event.which == 122)
					return true;
			
				if(!is_running) return false;
				nacl_nes.postMessage('button_down:' + event.which);
				return false;
			});

			// Send all key up events to the nacl app
			$('#bodyId').keyup(function(event) {
				// Let the browser handle F11 for full screen
				if(event.which == 122)
					return true;
			
				if(!is_running) return false;
				nacl_nes.postMessage('button_up:' + event.which);
				return false;
			});

			// Zoom in when clicked
			$('#zoom_in').click(function() {
				if(zoom < max_zoom)
					zoom += 1;

				$('#zoom_in').attr('disabled', zoom == max_zoom);
				$('#zoom_out').attr('disabled', zoom == 1);

				$('#NaclNesApp').width(256 * zoom);
				$('#NaclNesApp').height(240 * zoom);

				if(is_running)
					nacl_nes.postMessage('zoom:' + zoom);

				return false;
			});

			// Zoom out when clicked
			$('#zoom_out').click(function() {
				if(zoom > 1)
					zoom -= 1;

				$('#zoom_in').attr('disabled', zoom == max_zoom);
				$('#zoom_out').attr('disabled', zoom == 1);
			
				$('#NaclNesApp').width(256 * zoom);
				$('#NaclNesApp').height(240 * zoom);

				if(is_running)
					nacl_nes.postMessage('zoom:' + zoom);

				return false;
			});
			
			// Pause when the button is clicked
			$('#pause').click(function() {
				if(!is_running) return false;

				nacl_nes.postMessage('pause');
				var pause = $('#pause');
				if(pause.text() == 'Pause') {
					pause.text('Unpause');
				} else {
					pause.text('Pause');
				}

				return false;
			});

			// Load a game when one is selected
			$('#game_selector').change(function() {
				var id = $(this).find('option:selected').attr('id');
				if(id == 'none') return;

				$('#pause').attr('disabled', true);
				$('#pause').text('Pause');

				if(paintInterval != null) {
					clearInterval(paintInterval);
					paintInterval = null;
				}

				if(debugInterval != null) {
					clearInterval(debugInterval);
					debugInterval = null;
				}
			
				if(is_running) {
					nacl_nes.postMessage('quit');
				}
				load_rom('roms/' + id);
			});

			var listener = $('#listener')[0];
			listener.addEventListener('loadend', handleLoadEnd, true);
			listener.addEventListener('progress', handleProgress, true);
			listener.addEventListener('message', handleMessage, true);
			
			$('#zoom_in').attr('disabled', zoom == max_zoom);
			$('#zoom_out').attr('disabled', zoom == 1);
		</script>
	</body>
</html>


