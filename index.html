<!DOCTYPE html>
<html>
	<head>
		<title>SaltyNES - A NES emulator in the browser</title>
		<script src="jquery-1.8.2.min.js" type="text/javascript"></script>
		<script src="http://crypto-js.googlecode.com/svn/tags/3.0.2/build/rollups/sha256.js" type="text/javascript"></script>
		<script src="http://crypto-js.googlecode.com/svn/tags/3.0.2/build/components/core-min.js" type="text/javascript"></script>
		<script src="http://crypto-js.googlecode.com/svn/tags/3.0.2/build/components/enc-utf16-min.js" type="text/javascript"></script>
		<script src="http://crypto-js.googlecode.com/svn/tags/3.0.2/build/components/enc-base64-min.js" type="text/javascript"></script>
		<script src="game_database.json" type="text/javascript"></script>
		<script src="gamepad_database.json" type="text/javascript"></script>
		<style>
			html, body {
				height: 100%;
				background-color: #FFFFFF;
				font-family: 'Lucida Sans Unicode', 'Lucida Grande', sans-serif;
			}
			
			nav {
				float: left;
				min-height: 100%;
				width: 200px;
			}
			
			.screen_hidden {
				background-color: #FFFFFF;
				width: 2px;
				height: 2px;
			}
			
			.screen_running {
				background-color: #000000;
				width: 256px;
				height: 240px;
			}
			
			.game_icon {
				float: left;
				margin: 10px;
				padding: 0px;
				width: 120px;
				height: 177px;
			}

			.game_icon_none {
				float: left;
				margin: 10px;
				padding: 0px;
				width: 120px;
				height: 177px;
			}
			
			.broken {
				background-color: #FF0000;
			}

			.game_icon img {
				width: 100px;
				height: 137px;
				margin: 0 auto;
				padding: 0px;
			}
			
			.game_icon_none div {
				width: 100px;
				height: 137px;
				margin: 0 auto;
				padding: 0px;
				text-align: center;
				border: 1px solid black;
			}
			
			#gamepad_indicator {
				padding: 10px;
				text-align: center;
				border-radius: 15px;
				background-color: #009900;
			}
		</style>
	</head>
	<body id="bodyId" onunload="handlePageDidUnload()">
		<script type="text/javascript">
			var db = null;
			var salty_nes = null;
			var is_running = false;
			var paintInterval = null;
			var fpsInterval = null;
			var gamepadInterval = null;
			var vfps = 0;
			var zoom = 1;
			var max_zoom = 4;
			var breadcrumbs = [];
			var readers = [];
			var gamepad_id = null;

			function add_breadcrumb(breadcrumb) {
				// Just return if the last breadcrumb is the same is the one to add
				if(breadcrumbs.length > 0 && breadcrumb['title'] == breadcrumbs[breadcrumbs.length-1]['title']) {
					return;
				}
			
				// Add the breadcrumb
				breadcrumb['link'] = "remove_breadcrumbs_after('" + breadcrumb['title'] + "'); " + breadcrumb['link'];
				breadcrumbs.push(breadcrumb);
			}

			function update_breadcrumbs() {
				var breadcrumbs_div = $('#breadcrumbs_div')[0];

				breadcrumbs_div.innerHTML = "";
				for(var i=0; i<breadcrumbs.length; i++) {
					var title = breadcrumbs[i]['title'];
					var link = breadcrumbs[i]['link'];
					breadcrumbs_div.innerHTML += "<a href=\"#\" onclick=\"" + link + "\">" + title + "</a>";
					if(breadcrumbs.length > i+1)
						breadcrumbs_div.innerHTML += "&nbsp;&nbsp;&gt;&nbsp;&nbsp;";
				}
			}

			function remove_breadcrumbs_after(title) {
				// Get the pisition of the current crumb
				var count = 0;
				for(i=0; i< breadcrumbs.length; i++) {
					if(breadcrumbs[i]['title'] == title) {
						count = breadcrumbs.length - (i + 1);
					}
				}

				// Pop off the crumbs that are after
				for(i=0; i < count; i++) {
					breadcrumbs.pop();
				}
			
				// Draw the new breadcrumbs
				update_breadcrumbs();
			}

			function setup_indexeddb() {
				// Setup IndexedDB
				window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
				window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
				window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange
				if(!indexedDB) {
					alert("This application requires IndexedDB to work.");
				}
				
				// Connect to the database
				var request = indexedDB.open('SaltyNES', 1);
				request.onerror = function(event) {
					alert("This application requires IndexedDB to work.");
				};
				request.onupgradeneeded = function(event) {
					db = event.target.result;
					var objectStore = db.createObjectStore('games', { keyPath: 'sha256' });
					objectStore.createIndex('name', 'name', { unique: false });
				};
				request.onsuccess = function(event) {
					db = request.result;
				};
			}

			function load_game_library() {
				// Get all the existing links in the library
				var game_library = $('#game_library');
			
				// Load all the new games into the selector
				var objectStore = db.transaction(['games'], 'readwrite').objectStore('games');
				var index = objectStore.index('name');
				var is_first_icon = true;
				index.openCursor().onsuccess = function(event) {
					var cursor = event.target.result;
					if(cursor) {
						if(is_first_icon) {
							game_library[0].innerHTML = '';
							is_first_icon = false;
						}
						var game = cursor.value;
			
						// Put the icon in the selector
						var link_text = "";
						if(game.img != "") {
							var icon_class = game['is_broken'] ? 'game_icon broken' : 'game_icon';
							link_text = "<a id=\"" + game.sha256 + "\" href=\"" + game.name + "\" onclick=\"show_game_info('" + game.sha256 + "'); return false;\"><div class=\"" + icon_class + "\"><img src=\"" + game.img + "\" /><br />" + game.name + "</div></a>";
						} else {
							link_text = "<a id=\"" + game.sha256 + "\" href=\"" + game.name + "\" onclick=\"show_game_info('" + game.sha256 + "'); return false;\"><div class=\"game_icon_none\"><div>Unknown Game</div>" + game.name + "</div></a>";
						}
						game_library[0].innerHTML += link_text;
			
						cursor.continue();
					} else {

					}
				};
			}

			function load_rom(sha256) {
				// Get the game file from the database
				var objectStore = db.transaction(['games'], 'readwrite').objectStore('games');
				var request = objectStore.get(sha256);
				request.onsuccess = function(event) {
					// Send the rom to the nexes
					salty_nes.postMessage('load_rom:' + request.result.data);
					salty_nes.postMessage('zoom:' + zoom);
				};
			}

			function show_game_info(sha256) {
				$('#game_selector').hide();
				$('#game_info').show();
				$('#top_controls').hide();
				$('#game_drop').hide();
				$('#game_library').hide();
				$('#home_controls').hide();
				hide_screen();

				// Quit running any existing game
				if(is_running)
					salty_nes.postMessage('quit');
			
				// Get the game info from the database
				var objectStore = db.transaction(['games'], 'readwrite').objectStore('games');
				var request = objectStore.get(sha256);
				request.onsuccess = function(event) {
					var game = request.result;
					// Add the game info to the breadcrumbs
					add_breadcrumb({'title' : game.name, 'link' : "show_game_info('" + sha256 + "'); return false;"});
					update_breadcrumbs();
	
					// Fill in the info for this game
					var fields = ["name", "developer", "publisher", "region", "release_date", 
									"number_of_players", "can_save", "mapper", "char_rom_pages", "prog_rom_pages"];
					for(i=0; i<fields.length; i++) {
						var field = fields[i];
						var value = game[field];
						$('#game_' + field)[0].innerHTML = value;
					}
	
					// Fill in the image and link to wikipedia
					$('#game_link')[0].innerHTML = "<a href=\"" + game.link + "\">Wikipedia</a>";
					if(game.img) {
						$('#game_img')[0].innerHTML = "<img src=\"" + game.img + "\" width=\"200\"/>";
					} else {
						$('#game_img')[0].innerHTML = "<div style=\"width: 120px; height: 177px; border: 1px solid black;\">Unknown Game</div>";
					}
					$('#game_play_button').unbind('click');
					$('#game_play_button').click(function() {
						load_rom(sha256);
					});
			
					document.title = game.name + ' - SaltyNES';
				};
			}

			function show_home() {
				document.title = 'SaltyNES - A NES emulator in the browser'

				// Empty the fields fow showing a game
				var fields = ["name", "developer", "publisher", "region", "release_date", 
								"number_of_players", "can_save", "mapper", "char_rom_pages", "prog_rom_pages", 
								"link", "img"];
				for(i=0; i<fields.length; i++) {
					$('#game_' + fields[i])[0].innerHTML = '';
				}

				// Show all the games
				$('#game_selector').show();
				$('#game_info').hide();
				$('#top_controls').hide();
				$('#game_drop').hide();
				$('#game_library').hide();
				$('#home_controls').show();
				hide_screen();
			
				// Quit running any existing game
				if(is_running)
					salty_nes.postMessage('quit');
			}
			
			function show_library() {
				document.title = 'My Library - SaltyNES';
				add_breadcrumb({'title' : 'My Library', 'link' : "show_library(); return false;"});
				update_breadcrumbs();
			
				$('#game_selector').show();
				$('#game_info').hide();
				$('#top_controls').hide();
				$('#game_drop').hide();
				$('#game_library').show();
				$('#home_controls').hide();
				hide_screen();
			
				// Quit running any existing game
				if(is_running)
					salty_nes.postMessage('quit');
			
				load_game_library();
			}
			
			function show_drop() {
				document.title = 'Add to Library - SaltyNES';
				add_breadcrumb({'title' : 'Add to Library', 'link' : "show_drop(); return false;"});
				update_breadcrumbs();

				$('#game_selector').show();
				$('#game_info').hide();
				$('#top_controls').hide();
				$('#game_drop').show();
				$('#game_library').hide();
				$('#home_controls').hide();
				hide_screen();
			
				// Quit running any existing game
				if(is_running)
					salty_nes.postMessage('quit');
			}

			function hide_screen() {
				$('#SaltyNESApp')[0].className = 'screen_hidden';
				$('#SaltyNESApp').width(2);
				$('#SaltyNESApp').height(2);
			}

			function show_screen() {
				$('#SaltyNESApp')[0].className = 'screen_running';
				$('#SaltyNESApp').width(256 * zoom);
				$('#SaltyNESApp').height(240 * zoom);
			}

			function handleLibraryDragEnter(event) {
				// Do nothing
				event.stopPropagation();
				event.preventDefault();
			}

			function handleLibraryDragExit(event) {
				// Do nothing
				event.stopPropagation();
				event.preventDefault();
			}

			function handleLibraryDragOver(event) {
				// Do nothing
				event.stopPropagation();
				event.preventDefault();
			}

			function handleLibraryDrop(event) {
				// Do nothing
				event.stopPropagation();
				event.preventDefault();
			
				var files = event.dataTransfer.files;
				if(files.length > 0)
					handleLibraryFiles(files);
			}
			

			function handleLibraryFiles(files) {
				$('#game_drop_loading').show();
			
				// Read the files
				for(i=0; i<files.length; i++) {
					var file_name = files[i].name;
					var reader = new FileReader();

					reader.onprogress = function (event) {
						if(event.lengthComputable) {
							var loaded = (event.loaded / event.total);
						}
					};

					reader.onloadend = function(event) {
						// Convert the game from data uri to binary
						var header = event.target.result.split(',')[0];
						var mime_type = header.split(':')[1].split(';')[0];
						var base64 = event.target.result.slice(header.length+1);
						var data = CryptoJS.enc.Base64.parse(base64);
					
						// Get the sha256 of the data
						var sha256 = CryptoJS.SHA256(data).toString(CryptoJS.enc.Hex);
		
						// Save the base64ed game in the database
						var game = {};
						if(game_database[sha256] != undefined) {
							game = $.extend({}, game_database[sha256]);
						} else {
							game = {
								"name" : file_name,
								"developer" : "",
								"publisher" : "",
								"region" : "",
								"release_date" : "",
								"number_of_players" : 1,
								"can_save" : false,
								"mapper" : 0,
								"prog_rom_pages" : 0,
								"char_rom_pages" : 0,
								"link" : "",
								"img" : "",
								"is_broken" : false
							};
						}
						game['sha256'] = sha256;
						game['data'] = base64;
			
						var objectStore = db.transaction(['games'], 'readwrite').objectStore('games');
						var request = objectStore.add(game);
						request.onsuccess = function(event) {
							$('#debug')[0].innerHTML = "Loaded '" + game['name'] + "'";
				
							// Start the next reader, if there is one
							if(readers.length > 0) {
								var next = readers.pop();
								next['reader'].readAsDataURL(next['file']);
							}
			
							if(readers.length == 0)
								$('#game_drop_loading').hide();
						};
			
						request.onerror = function(event) {
							// Start the next reader, if there is one
							if(readers.length > 0) {
								var next = readers.pop();
								next['reader'].readAsDataURL(next['file']);
							}
			
							if(readers.length == 0)
								$('#game_drop_loading').hide();
						};
					};

					// Add this reader to the list of readers
					readers.push({ 'reader' : reader, 'file' : files[i] });
				}
			
				// Start the first reader
				if(readers.length > 0) {
					var next = readers.pop();
					next['reader'].readAsDataURL(next['file']);
				}
			}

			function handleKeyDown(event) {
				// Let the browser handle F11 for full screen
				if(event.which == 122)
					return true;
			
				if(!is_running) return false;
				salty_nes.postMessage('key_down:' + event.which);
				return false;
			}
			
			function handleKeyUp(event) {
				// Let the browser handle F11 for full screen
				if(event.which == 122)
					return true;
			
				if(!is_running) return false;
				salty_nes.postMessage('key_up:' + event.which);
				return false;
			}
			
			function handleZoomInClick() {
				if(zoom < max_zoom)
					zoom += 1;

				$('#zoom_in').attr('disabled', zoom == max_zoom);
				$('#zoom_out').attr('disabled', zoom == 1);

				$('#SaltyNESApp').width(256 * zoom);
				$('#SaltyNESApp').height(240 * zoom);

				if(is_running)
					salty_nes.postMessage('zoom:' + zoom);

				return false;
			}
			
			function handleZoomOutClick() {
				if(zoom > 1)
					zoom -= 1;

				$('#zoom_in').attr('disabled', zoom == max_zoom);
				$('#zoom_out').attr('disabled', zoom == 1);
			
				$('#SaltyNESApp').width(256 * zoom);
				$('#SaltyNESApp').height(240 * zoom);

				if(is_running)
					salty_nes.postMessage('zoom:' + zoom);

				return false;
			}
			
			function handlePauseClick() {
				if(!is_running) return false;

				salty_nes.postMessage('pause');
				var pause = $('#pause');
				if(pause.text() == 'Pause') {
					pause.text('Unpause');
				} else {
					pause.text('Pause');
				}

				return false;
			}
			
			function handlePageDidUnload() {
				if(paintInterval) {
					clearInterval(paintInterval);
					paintInterval = null;
				}

				if(fpsInterval) {
					clearInterval(fpsInterval);
					fpsInterval = null;
				}

				if(gamepadInterval) {
					clearInterval(gamepadInterval);
					gamepadInterval = null;
				}
			}
			
			function handleNaclMessage(message_event) {
				if(message_event.data == null)
					return;
			
				if(message_event.data.split(':')[0] == 'get_fps') {
					var fpsdebug = $('#fpsdebug')[0];
					fpsdebug.innerHTML = 'FPS: ' + vfps + ', VFPS: ' + message_event.data.split(':')[1];
					vfps = 0;
				} else if(message_event.data.split(':')[0] == 'get_sha256') {
					// FIXME: remove this
				} else if(message_event.data.split(':')[0] == 'get_gamepad_status') {
					var status = message_event.data.split(':')[1];
					var new_gamepad_id = message_event.data.split(':')[2];
					if(status == "yes") {
						$('#gamepad_indicator').show();
					} else {
						$('#gamepad_indicator').hide();
					}
			
					// Update the key bindings if this is a new gamepad
					if(is_running && new_gamepad_id && new_gamepad_id != gamepad_id) {
						var buttons = null;
						if(new_gamepad_id in gamepad_database) {
							buttons = gamepad_database[new_gamepad_id]['input_map'];
						} else {
							buttons = gamepad_database['unknown']['input_map'];
						}
						for(var key in buttons) {
							for(var i=0; i<buttons[key].length; i++) {
								salty_nes.postMessage('set_input_' + key + ':' + buttons[key][i]);
							}
						}
						gamepad_id = new_gamepad_id;
					}
				} else if(message_event.data == 'running') {
					is_running = true;
			
					// Add the game info to the breadcrumbs
					add_breadcrumb({'title' : 'Play', 'link' : "return false;"});
					update_breadcrumbs();
			
					// Repaint the screen
					// FIXME: Paint calls should happen automatically inside the nexe.
					var fps = 60.0;
					paintInterval = setInterval(function() {
						salty_nes.postMessage('paint');
						vfps += 1;
					}, 1000.0 / fps);

					// Have the FPS sent to us every second
					// FIXME: This should just be sent from the nexe directly
					fpsInterval = setInterval(function() {
						salty_nes.postMessage('get_fps');
					}, 1000);
			
					// Make the pause button clickable
					$('#pause').attr('disabled', false);
					
					// Get the rom sha256
					salty_nes.postMessage('get_sha256');

					$('#game_info').hide();
					$('#top_controls').show();
					show_screen();
			
					var debug = $('#debug')[0];
					debug.innerHTML = 'Running';
				} else if(message_event.data == 'quit') {
					is_running = false;
					if(paintInterval) {
						clearInterval(paintInterval);
						paintInterval = null;
					}
					if(fpsInterval) {
						clearInterval(fpsInterval);
						fpsInterval = null;
					}
			
					var debug = $('#debug')[0];
					debug.innerHTML = 'Ready';
				} else {
					var debug = $('#debug')[0];
					debug.innerHTML = message_event.data;
				}
			}

			function handleNaclProgress(event) {
				var debug = $('#debug')[0];
				// Print unknown progress if unknown
				if(!event.lengthComputable || event.total == 0) {
					debug.innerHTML = 'Loading ' + event.loaded + ' Bytes of unknown total size';
					return;
				}

				// Or print progress
				var progress = event.loaded / event.total * 100.0;
				debug.innerHTML = 'Loading ' + progress.toFixed(2) + '% ...';
			}

			function handleNaclLoadStart(event) {
				$('#nacl_not_enabled').hide();
			}
			
			function handleNaclLoadEnd() {
				salty_nes = $('#SaltyNESApp')[0];

				add_breadcrumb({'title' : 'Home', 'link' : "show_home(); return false;"});
				update_breadcrumbs();
			
				// Start getting the gamepad status
				gamepadInterval = setInterval(function() {
					salty_nes.postMessage('get_gamepad_status');
				}, 2000);
			
				var debug = $('#debug')[0];
				debug.innerHTML = 'Ready';
				$('#game_selector').show();
			}
			
			$(document).ready(function() {
				// Setup IndexedDB
				setup_indexeddb();

				// Setup game drag and drop
				var game_drop = $('#game_drop')[0];
				game_drop.addEventListener("dragenter", handleLibraryDragEnter, true);
				game_drop.addEventListener("dragexit", handleLibraryDragExit, true);
				game_drop.addEventListener("dragover", handleLibraryDragOver, true);
				game_drop.addEventListener("drop", handleLibraryDrop, true);
			
				// Send all key down events to the NACL app
				$('#bodyId').keydown(handleKeyDown);
				$('#bodyId').keyup(handleKeyUp);
	
				// Setup zoom
				$('#zoom_in').click(handleZoomInClick);
				$('#zoom_out').click(handleZoomOutClick);
				$('#zoom_in').attr('disabled', zoom == max_zoom);
				$('#zoom_out').attr('disabled', zoom == 1);
				
				// Pause when the button is clicked
				$('#pause').click(handlePauseClick);
			
				// Setup NACL loader
				var listener = $('#listener')[0];
				listener.addEventListener('loadstart', handleNaclLoadStart, true);
				listener.addEventListener('loadend', handleNaclLoadEnd, true);
				listener.addEventListener('progress', handleNaclProgress, true);
				listener.addEventListener('message', handleNaclMessage, true);
			});
			
		</script>
		<nav>
			<span style="font-size: 1.7em;">SaltyNES</span> is a NES emulator in the browser.
			<p>
				<b>Status:</b><br />
				<span id="debug">Debug messages will be printed here</span>
			</p>

			<p>
				<b>Controls:</b><br />
				Enter = Start<br />
				Ctrl = Select<br />
				Z = B<br />
				X = A<br />
				Arrow keys = D-Pad
			</p>

			<p id="gamepad_indicator" style="display: none;">
				<b>Gamepad is connected</b>
			</p>
		</nav>
		
		<div id="listener" style="overflow: auto; text-align: center;">
			<div id="nacl_not_enabled" style="overflow: auto; clear: both; text-align: left; margin: 40px;">
				<p>
					SaltyNES requires Google Native Client to run. Native Client is not enabled. Visit the page 
					<span style="font-family: courier;">"chrome://flags"</span> and enable it.
				</p>
				<img src="enable_nacl.png" />
			</div>
			
			<div id="breadcrumbs_div" style="overflow: auto; clear: both; float: left;">
			</div>
		
			<div id="top_controls" style="overflow: auto; clear: both; display: none;">
				<button id="pause" disabled="disabled">Pause</button>
				zoom: 
				<button id="zoom_out" disabled="disabled">-</button>
				<button id="zoom_in" disabled="disabled">+</button>
				<span id="fpsdebug"></span>
			</div>

			<div id="game_selector" style="overflow: auto; clear: both; display: none;">
				<div id="home_controls" style="overflow: auto; clear: both;">
					<a href="Add to Library" onclick="show_drop(); return false;">
						<button style="width: 50%; height: 100px; float: left;">
						Add to Library
						</button>
					</a>
					<a href="My Library" onclick="show_library(); return false;">
						<button style="width: 50%; height: 100px; float: left;">
						My Library
						</button>
					</a>
				</div>
				<div id="game_drop" style="overflow: auto; clear: both; height: 170px; border: 10px solid green; display: none;">
					<p>Drop games here to save in your library.</p>
					<img id="game_drop_loading" style="display: none;" src="loading.gif" />
				</div>
				<div id="game_library" style="overflow: auto; clear: both; min-height: 200px; display: none;">
					<p>There are no games in your library.</p>
				</div>
			</div>

			<div id="game_info" style="overflow: auto; clear: both; text-align: left; display: none;">
				<h2><span  id="game_name">...</span></h2>
				<span id="game_img" style="float: left; margin: 10px;">...</span><br />
				<button id="game_play_button" style="float: left; width: 150px; height: 100px; margin: 50px;">Play</button>
				<br style="clear: both;" />
				Developer: <span  id="game_developer">...</span><br />
				Publisher: <span  id="game_publisher">...</span><br />
				Region: <span  id="game_region">...</span><br />
				Release date: <span  id="game_release_date">...</span><br />
				Number of players: <span  id="game_number_of_players">...</span><br />
				Can save: <span  id="game_can_save">...</span><br />
				Prog ROM pages: <span  id="game_prog_rom_pages">...</span><br />
				Char ROM pages: <span  id="game_char_rom_pages">...</span><br />
				Mapper: <span  id="game_mapper">...</span><br />
				Link: <span  id="game_link">...</span><br />
			</div>
		
			<embed name="nacl_module"
				id="SaltyNESApp"
				class="screen_hidden"
				src="newlib/salty_nes.nmf"
				type="application/x-nacl" />
		</div>
	</body>
</html>


