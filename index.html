<!DOCTYPE html>
<html>
	<head>
		<title>SaltyNES - A NES emulator in the browser.</title>
		<script src="jquery-1.8.2.min.js" type="text/javascript"></script>
		<script src="http://crypto-js.googlecode.com/svn/tags/3.0.2/build/rollups/sha256.js"></script>
		<script src="http://crypto-js.googlecode.com/svn/tags/3.0.2/build/components/core-min.js"></script>
		<script src="http://crypto-js.googlecode.com/svn/tags/3.0.2/build/components/enc-utf16-min.js"></script>
		<script src="http://crypto-js.googlecode.com/svn/tags/3.0.2/build/components/enc-base64-min.js"></script>

		<script src="game_database.json" type="text/javascript"></script>
		<style>
			html, body {
				height: 100%;
				background-color: #FFFFFF;
				font-family: 'Lucida Sans Unicode', 'Lucida Grande', sans-serif;
			}
			
			nav {
				float: left;
				min-height: 100%;
				width: 200px;
			}
			
			.screen_hidden {
				background-color: #FFFFFF;
				width: 2px;
				height: 2px;
			}
			
			.screen_running {
				background-color: #000000;
				width: 256px;
				height: 240px;
			}
			
			.game_icon {
				float: left;
				margin: 10px;
				padding: 0px;
				width: 120px;
				height: 177px;
			}

			.broken {
				background-color: #FF0000;
			}

			.game_icon img {
				width: 100px;
				height: 137px;
				margin: 0 auto;
				padding: 0px;
			}
			
			#gamepad_indicator {
				padding: 10px;
				text-align: center;
				border-radius: 15px;
				background-color: #009900;
			}
		</style>
	</head>
	<body id="bodyId" onunload="pageDidUnload()">
		<script type="text/javascript">
			var salty_nes = null;
			var is_running = false;
			var paintInterval = null;
			var debugInterval = null;
			var gamepadInterval = null;
			var vfps = 0;
			var zoom = 1;
			var max_zoom = 4;
			var breadcrumbs = [];

			function handleMessage(message_event) {
				if(message_event.data.split(':')[0] == 'get_fps') {
					var debug = $('#debug')[0];
					debug.innerHTML = 'FPS: ' + vfps + ', VFPS: ' + message_event.data.split(':')[1];
					vfps = 0;
				} else if(message_event.data.split(':')[0] == 'get_sha256') {
					// FIXME: remove this
				} else if(message_event.data.split(':')[0] == 'get_gamepad_status') {
					var status = message_event.data.split(':')[1];
					if(status == "yes") {
						$('#gamepad_indicator')[0].style.display = '';
					} else {
						$('#gamepad_indicator')[0].style.display = 'none';
					}
				} else if(message_event.data == 'running') {
					is_running = true;
			
					// Add the game info to the breadcrumbs
					add_breadcrumb({'title' : 'Play', 'link' : "return false;"});
					update_breadcrumbs();
			
					// Repaint the screen
					// FIXME: Paint calls should happen automatically inside the nexe.
					var fps = 60.0;
					paintInterval = setInterval(function() {
						salty_nes.postMessage('paint');
						vfps += 1;
					}, 1000.0 / fps);

					// Have the FPS sent to us every second
					// FIXME: This should just be sent from the nexe directly
					debugInterval = setInterval(function() {
						salty_nes.postMessage('get_fps');
					}, 1000);
			
					// Make the pause button clickable
					$('#pause').attr('disabled', false);
					
					// Get the rom sha256
					salty_nes.postMessage('get_sha256');

					$('#game_info')[0].style.display = 'none';
					$('#top_controls')[0].style.display = '';
					show_screen();
			
					var debug = $('#debug')[0];
					debug.innerHTML = message_event.data;
				} else if(message_event.data == 'quit') {
					is_running = false;
					if(paintInterval) {
						clearInterval(paintInterval);
						paintInterval = null;
					}
					if(debugInterval) {
						clearInterval(debugInterval);
						debugInterval = null;
					}
				} else {
					var debug = $('#debug')[0];
					debug.innerHTML = message_event.data;
				}
			}

			function handleProgress(event) {
				var debug = $('#debug')[0];
				// Print unknown progress if unknown
				if(!event.lengthComputable || event.total == 0) {
					debug.innerHTML = 'Loading ' + event.loaded + ' Bytes of unknown total size';
					return;
				}

				// Or print progress
				var progress = event.loaded / event.total * 100.0;
				debug.innerHTML = 'Loading ' + progress.toFixed(2) + '% ...';
			}

			function handleLoadStart(event) {
				$('#nacl_not_enabled')[0].style.display = 'none';
			}
			
			function handleLoadEnd() {
				salty_nes = $('#SaltyNESApp')[0];

				add_breadcrumb({'title' : 'Games', 'link' : "show_games(); return false;"});
				update_breadcrumbs();
			
				var debug = $('#debug')[0];
				debug.innerHTML = 'Loaded';
			
				// Start getting the gamepad status
				gamepadInterval = setInterval(function() {
					salty_nes.postMessage('get_gamepad_status');
				}, 2000);
			
				load_game_selector();
			}
			
			function load_game_selector() {
				// Load all the games into the selector
				var game_selector = $('#game_selector')[0];
				game_selector.innerHTML = '';
			
				for(var key in localStorage) {
					if(game_database[key] != undefined) {
						var game = game_database[key];
						var icon_class = game['is_broken'] ? 'game_icon broken' : 'game_icon';
						game_selector.innerHTML += "<a href=\"" + game['name'] + "\" onclick=\"show_game_info('" + key + "'); return false;\"><div class=\"" + icon_class + "\"><img src=\"" + game["img"] + "\" /><br />" + game['name'] + "</div></a>";
					}
				}
			}

			function pageDidUnload() {
				if(paintInterval) {
					clearInterval(paintInterval);
					paintInterval = null;
				}

				if(debugInterval) {
					clearInterval(debugInterval);
					debugInterval = null;
				}

				if(gamepadInterval) {
					clearInterval(gamepadInterval);
					gamepadInterval = null;
				}
			}

			function load_rom(sha256) {
				// Send the rom to the nexe
				salty_nes.postMessage('load_rom:' + localStorage[sha256]);
				salty_nes.postMessage('zoom:' + zoom);
			}

			function show_game_info(sha256) {
				$('#game_selector')[0].style.display = 'none';
				$('#game_info')[0].style.display = '';
				$('#top_controls')[0].style.display = 'none';
				hide_screen();

				// Quit running any existing game
				if(is_running)
					salty_nes.postMessage('quit');
			
				// Add the game info to the breadcrumbs
				add_breadcrumb({'title' : game_database[sha256]['name'], 'link' : "show_game_info('" + sha256 + "'); return false;"});
				update_breadcrumbs();

				// Fill in the info for this game
				var has_fields = game_database[sha256] != undefined;
				var fields = ["name", "developer", "publisher", "region", "release_date", 
								"number_of_players", "can_save", "mapper", "char_rom_pages", "prog_rom_pages"];
				for(i=0; i<fields.length; i++) {
					var field = fields[i];
					var value = '?';
					if(has_fields)
						value = game_database[sha256][field];
					$('#game_' + field)[0].innerHTML = value;
				}

				// Fill in the image and link to wikipedia
				if(has_fields) {
					$('#game_link')[0].innerHTML = "<a href=\"" + game_database[sha256]['link'] + "\">Wikipedia</a>";
					$('#game_img')[0].innerHTML = "<img src=\"" + game_database[sha256]['img'] + "\" width=\"200\"/>";
					$('#game_play_button').unbind('click');
					$('#game_play_button').click(function() {
						load_rom(sha256);
					});
				}
			}

			function show_games() {
				// Empty the fields fow showing a game
				var fields = ["name", "developer", "publisher", "region", "release_date", 
								"number_of_players", "can_save", "mapper", "char_rom_pages", "prog_rom_pages", 
								"link", "img"];
				for(i=0; i<fields.length; i++) {
					$('#game_' + fields[i])[0].innerHTML = '';
				}

				// Show all the games
				$('#game_selector')[0].style.display = '';
				$('#game_info')[0].style.display = 'none';
				$('#top_controls')[0].style.display = 'none';
				hide_screen();
			
				// Quit running any existing game
				if(is_running)
					salty_nes.postMessage('quit');
			}
			
			function add_breadcrumb(breadcrumb) {
				// Just return if the last breadcrumb is the same is the one to add
				if(breadcrumbs.length > 0 && breadcrumb['title'] == breadcrumbs[breadcrumbs.length-1]['title']) {
					return;
				}
			
				// Add the breadcrumb
				breadcrumb['link'] = "remove_breadcrumbs_after('" + breadcrumb['title'] + "'); " + breadcrumb['link'];
				breadcrumbs.push(breadcrumb);
			}
			
			function update_breadcrumbs() {
				var breadcrumbs_div = $('#breadcrumbs_div')[0];

				breadcrumbs_div.innerHTML = "";
				for(var i=0; i<breadcrumbs.length; i++) {
					var title = breadcrumbs[i]['title'];
					var link = breadcrumbs[i]['link'];
					breadcrumbs_div.innerHTML += "<a href=\"#\" onclick=\"" + link + "\">" + title + "</a>";
					if(breadcrumbs.length > i+1)
						breadcrumbs_div.innerHTML += "&nbsp;&nbsp;&gt;&nbsp;&nbsp;";
				}
			}
			
			function remove_breadcrumbs_after(title) {
				// Get the pisition of the current crumb
				var count = 0;
				for(i=0; i< breadcrumbs.length; i++) {
					if(breadcrumbs[i]['title'] == title) {
						count = breadcrumbs.length - (i + 1);
					}
				}

				// Pop off the crumbs that are after
				for(i=0; i < count; i++) {
					breadcrumbs.pop();
				}
			
				// Draw the new breadcrumbs
				update_breadcrumbs();
			}

			function hide_screen() {
				$('#SaltyNESApp')[0].className = 'screen_hidden';
				$('#SaltyNESApp').width(2);
				$('#SaltyNESApp').height(2);
			}

			function show_screen() {
				$('#SaltyNESApp')[0].className = 'screen_running';
				$('#SaltyNESApp').width(256 * zoom);
				$('#SaltyNESApp').height(240 * zoom);
			}

			function dragEnter(event) {
				event.stopPropagation();
				event.preventDefault();
			}

			function dragExit(event) {
				event.stopPropagation();
				event.preventDefault();
			}

			function dragOver(event) {
				event.stopPropagation();
				event.preventDefault();
			}

			function drop(event) {
				event.stopPropagation();
				event.preventDefault();
			
				var files = event.dataTransfer.files;
				if(files.length > 0)
					handleFiles(files);
			}
			

			function handleFiles(files) {
				//var file = files[0];
			
				$('#droplabel')[0].innerHTML = '';//file.name;
			
				// Read the files
				for(i=0; i<files.length; i++) {
					var reader = new FileReader();
					reader.onprogress = handleReaderProgress;
					reader.onloadend = handleReaderLoadEnd;
					reader.readAsDataURL(files[i]);
				}
			}

			function handleReaderProgress(event) {
				if(event.lengthComputable) {
					var loaded = (event.loaded / event.total);
				}
			}

			function handleReaderLoadEnd(event) {
				// Convert the game from data uri to binary
				var header = event.target.result.split(',')[0];
				var mime_type = header.split(':')[1].split(';')[0];
				var base64 = event.target.result.slice(header.length+1);
				var data = CryptoJS.enc.Base64.parse(base64);
			
				// Get the sha256 of the data
				var sha256 = CryptoJS.SHA256(data).toString(CryptoJS.enc.Hex);

				// Save the base64ed game in the localStorage
				localStorage[sha256] = base64;
				var message = "Loaded '" + game_database[sha256]['name'] + "', ";
			
				$('#droplabel')[0].innerHTML += message;
			
				load_game_selector();
			}
			
		</script>
		<nav>
			<span style="font-size: 1.7em;">SaltyNES</span> is a NES emulator in the browser.
			<p>
				<b>Status:</b><br />
				<span id="debug">Debug messages will be printed here</span>
			</p>

			<p>
				<b>Controls:</b><br />
				Enter = Start<br />
				Ctrl = Select<br />
				Z = B<br />
				X = A<br />
				Arrow keys = D-Pad
			</p>

			<p id="gamepad_indicator" style="display: none;">
				<b>Gamepad is connected</b>
			</p>
		</nav>
		
		<div id="listener" style="overflow: auto; text-align: center;">
			<div id="nacl_not_enabled" style="overflow: auto; clear: both; text-align: left; margin: 40px;">
				<p>
					SaltyNES requires Google Native Client to run. Native Client is not enabled. Visit the page 
					<span style="font-family: courier;">"chrome://flags"</span> and enable it.
				</p>
				<img src="enable_nacl.png" />
			</div>
			
			<div id="breadcrumbs_div" style="overflow: auto; clear: both; float: left;">
			</div>

			<div id="dropbox" style="overflow: auto; clear: both; height: 200px; border: 1px solid red;">
				<span id="droplabel">Drop games here to save in database ...</span>
			</div>
		
			<div id="top_controls" style="overflow: auto; clear: both; display: none;">
				<button id="pause" disabled="disabled">Pause</button>
				zoom: 
				<button id="zoom_out" disabled="disabled">-</button>
				<button id="zoom_in" disabled="disabled">+</button>
			</div>

			<div id="game_selector" style="overflow: auto; clear: both;">
			</div>

			<div id="game_info" style="overflow: auto; clear: both; text-align: left; display: none;">
				<h2><span  id="game_name">...</span></h2>
				<span id="game_img" style="float: left; margin: 10px;">...</span><br />
				<button id="game_play_button" style="float: left; width: 150px; height: 100px; margin: 50px;">Play</button>
				<br style="clear: both;" />
				Developer: <span  id="game_developer">...</span><br />
				Publisher: <span  id="game_publisher">...</span><br />
				Region: <span  id="game_region">...</span><br />
				Release date: <span  id="game_release_date">...</span><br />
				Number of players: <span  id="game_number_of_players">...</span><br />
				Can save: <span  id="game_can_save">...</span><br />
				Prog ROM pages: <span  id="game_prog_rom_pages">...</span><br />
				Char ROM pages: <span  id="game_char_rom_pages">...</span><br />
				Mapper: <span  id="game_mapper">...</span><br />
				Link: <span  id="game_link">...</span><br />
			</div>
		
			<embed name="nacl_module"
				id="SaltyNESApp"
				class="screen_hidden"
				src="newlib/salty_nes.nmf"
				type="application/x-nacl" />
		</div>

		<script type="text/javascript">
			// Send all key down events to the nacl app
			$('#bodyId').keydown(function(event) {
				// Let the browser handle F11 for full screen
				if(event.which == 122)
					return true;
			
				if(!is_running) return false;
				salty_nes.postMessage('button_down:' + event.which);
				return false;
			});

			// Send all key up events to the nacl app
			$('#bodyId').keyup(function(event) {
				// Let the browser handle F11 for full screen
				if(event.which == 122)
					return true;
			
				if(!is_running) return false;
				salty_nes.postMessage('button_up:' + event.which);
				return false;
			});

			// Zoom in when clicked
			$('#zoom_in').click(function() {
				if(zoom < max_zoom)
					zoom += 1;

				$('#zoom_in').attr('disabled', zoom == max_zoom);
				$('#zoom_out').attr('disabled', zoom == 1);

				$('#SaltyNESApp').width(256 * zoom);
				$('#SaltyNESApp').height(240 * zoom);

				if(is_running)
					salty_nes.postMessage('zoom:' + zoom);

				return false;
			});

			// Zoom out when clicked
			$('#zoom_out').click(function() {
				if(zoom > 1)
					zoom -= 1;

				$('#zoom_in').attr('disabled', zoom == max_zoom);
				$('#zoom_out').attr('disabled', zoom == 1);
			
				$('#SaltyNESApp').width(256 * zoom);
				$('#SaltyNESApp').height(240 * zoom);

				if(is_running)
					salty_nes.postMessage('zoom:' + zoom);

				return false;
			});
			
			// Pause when the button is clicked
			$('#pause').click(function() {
				if(!is_running) return false;

				salty_nes.postMessage('pause');
				var pause = $('#pause');
				if(pause.text() == 'Pause') {
					pause.text('Unpause');
				} else {
					pause.text('Pause');
				}

				return false;
			});

			var listener = $('#listener')[0];
			listener.addEventListener('loadstart', handleLoadStart, true);
			listener.addEventListener('loadend', handleLoadEnd, true);
			listener.addEventListener('progress', handleProgress, true);
			listener.addEventListener('message', handleMessage, true);
			
			$('#zoom_in').attr('disabled', zoom == max_zoom);
			$('#zoom_out').attr('disabled', zoom == 1);

			$(document).ready(function() {
				var dropbox = $('#dropbox')[0];
			
				// init event handlers
				dropbox.addEventListener("dragenter", dragEnter, false);
				dropbox.addEventListener("dragexit", dragExit, false);
				dropbox.addEventListener("dragover", dragOver, false);
				dropbox.addEventListener("drop", drop, false);
			
				// init the widgets
				//$("#progressbar").progressbar();
			});
		</script>
	</body>
</html>


